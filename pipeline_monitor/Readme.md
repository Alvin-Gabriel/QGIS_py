QGIS管线监控插件 - 分阶段工作内容清单
本计划将插件开发分为五个核心阶段，从建立基础框架到实现高级功能，最后进行优化和交付。
阶段一：核心框架搭建与基础可视化 (MVP - 最小可用产品)
目标： 打通插件与数据库的连接，将最核心的数据（测试桩和管线）在QGIS地图上展示出来。此阶段完成后，您将拥有一个可以基本浏览数据的功能原型。
1. 插件UI与后端框架搭建：
前端 (UI设计 - Qt Designer):
使用Qt Designer打开 pipeline_monitor_dialog_base.ui。
设计主对话框的基本布局。至少添加以下控件并设置好objectName：
一个按钮 (QPushButton)，命名为 loadDataButton，文本为“加载/刷新数据”。
一个列表框 (QListWidget) 或表格 (QTableWidget)，命名为 pileListWidget，用于显示测试桩列表。
一个标签 (QLabel)，命名为 statusLabel，用于显示状态信息（如“未加载”、“加载中...”、“加载成功”）。
后端 (Python逻辑):
将您之前编写的数据库操作代码 (db_operations.py) 整合到插件项目中，确保可以被 pipeline_monitor_dialog.py 导入。
在 pipeline_monitor.py 的 run() 方法中，实现首次打开对话框时自动调用一次数据加载的逻辑。
2. 实现数据加载与地图显示功能：
后端 (Python逻辑 - pipeline_monitor_dialog.py):
编写 load_and_display_data 方法。
将 loadDataButton 的 clicked 信号连接到 load_and_display_data 方法。
在 load_and_display_data 方法中实现以下核心逻辑：
连接到MySQL数据库。
调用数据库函数获取所有测试桩的数据。
创建QGIS图层：
创建一个点内存图层 (QgsVectorLayer) 用于显示测试桩。
创建一个线内存图层，按照ID或特定顺序连接测试桩，形成管线。
将这两个图层添加到QGIS地图画布 (QgsProject.instance().addMapLayer())。
将测试桩的名称填充到UI界面的 pileListWidget 列表框中。
根据操作结果更新 statusLabel 的文本。
阶段二：增强可视化与专题制图
目标： 让地图上的数据“活起来”，根据业务数据（电压、风险等级）对地理要素进行符号化渲染，实现直观的专题图效果。
1. 后端数据逻辑增强：
编写一个新的数据库查询函数，用于获取每个测试桩最新的电压读数。
根据计划书中的“风险指标计算算法”（第9页），在Python中实现一个函数，该函数接收电压等参数，返回一个风险等级（如：高、中、低）。
2. 地图渲染逻辑实现：
后端 (Python逻辑 - pipeline_monitor_dialog.py):
修改 load_and_display_data 方法：在创建测试桩要素时，将最新的电压值和计算出的风险等级作为属性添加到每个要素中。
实现分级渲染：
使用 QgsGraduatedSymbolRenderer 或 QgsCategorizedSymbolRenderer 创建一个渲染器。
定义不同风险等级或电压范围对应的颜色和符号。
将此渲染器应用到测试桩点图层。
（可选）实现对管线线图层根据风险等级进行着色。
前端 (UI设计 - Qt Designer):
在主对话框中添加一个区域（如 QTextBrowser 或一组 QLabel），用于显示图例，说明不同颜色代表的风险等级。
阶段三：交互式工具与详细信息弹窗
目标： 从静态展示转向动态交互，允许用户通过点击地图上的要素来获取更详细的信息。
1. 实现地图点击交互：
后端 (Python逻辑 - pipeline_monitor.py):
创建一个自定义的地图工具类，继承自 QgsMapToolIdentifyFeature。
实现该工具类的逻辑，使其在激活时能够捕获地图点击事件，并识别被点击的测试桩要素。
在插件主对话框中添加一个按钮，用于激活/取消这个自定义地图工具。
2. 创建测试桩详细信息弹窗：
前端 (UI设计 - Qt Designer):
创建一个新的UI文件（例如 pile_details_dialog.ui），用于设计测试桩详细信息弹窗。
在弹窗中添加用于显示静态信息（名称、经纬度、当前电压、风险描述）的QLabel。
在弹窗中预留一个空白的 QWidget 作为容器，用于之后嵌入matplotlib图表，命名为 chartContainer。
后端 (Python逻辑):
创建一个新的Python文件 pile_details_dialog.py 来控制这个新弹窗。
当地图工具识别到测试桩被点击时，创建并显示 PileDetailsDialog 的实例，并将被点击测试桩的ID和属性信息传递给它。
弹窗的逻辑负责将接收到的数据显示在对应的QLabel上。
3. 集成电压历史曲线图：
后端 (Python逻辑 - pile_details_dialog.py):
在弹窗的逻辑中，根据传入的测试桩ID，查询数据库获取其一段时间内的所有电压历史数据。
使用 matplotlib 库生成电压-时间曲线图。
将生成的matplotlib图表嵌入到 chartContainer 控件中。
阶段四：高级功能与数据管理
目标： 实现计划书中提出的更高级、更专业的功能，特别是数据入口和高级可视化。
1. 实现数据导入向导 (计划书核心需求):
设计并实现一个多步骤的对话框，用于引导用户从CSV等文件导入数据。
该向导需要支持：文件选择、格式定义（分隔符等）、坐标系统(CRS)指定、字段映射。
实现将向导中配置好的数据写入MySQL数据库的后端逻辑。
2. 实现高级可视化与工具：
热力图功能: 在插件主对话框添加一个按钮，点击后能基于当前测试桩的风险/电压属性，生成并显示一个热力图图层。
底图切换功能: 在主对话框添加一个下拉框或一组按钮，用于切换不同的在线底图（如天地图、高德地图等）。
手动添加干扰源: 创建一个新的地图工具，允许用户在地图上点击，弹出一个表单来输入干扰源信息，并保存到数据库的新表中。
阶段五：定稿、优化与交付
目标： 对插件进行全面测试和优化，提升用户体验，编写文档，准备最终交付。
1. 功能完善与用户体验 (UX) 优化：
定时自动刷新: 使用 QTimer 实现定期从数据库刷新数据的功能，并提供UI开关让用户控制。
全面的错误处理: 为数据库连接失败、文件读取错误、数据格式不匹配等情况添加明确的用户提示。
用户反馈: 在执行耗时操作（如加载大量数据）时，提供进度提示或“加载中”的状态反馈。
代码重构与优化: 检查并优化性能瓶颈，特别是数据库查询和地图渲染部分。
2. 测试与文档：
对所有功能进行全面的测试，特别是在不同数据情况下的表现。
编写详细的用户操作手册，图文并茂地说明如何安装和使用插件的各项功能。
3. 打包与交付：
确认所有资源文件（如图标）、依赖项都已包含在内。
将插件文件夹打包成 ZIP 文件，形成最终的可分发安装包。
通过遵循这个分阶段的计划，您可以系统地构建您的插件，确保每个阶段都有明确的目标和可交付的成果。
